在进行了特定等距离点有限差分求权重后，我们需要完善一个以任意节点为基础求权重的算法。而fornberg算法就能帮助我们确定任意节点的权重。

想象你现在有一组数据点，但是你不知道他们所组成的函数是什么

-  有限差分就是：利用周围几个点的数值，加权平均一下，算出一个近似的导数值
- 权重就是：每个点的数值在计算中占多大比例

而fornberg的算法目标就是：给你任意的一组坐标点x，告诉你每一个节点应该乘以多少的权重c，才能精确的算出这一点插值的m阶导数。

$$f^{(m)}(z) \approx \sum_{i=0}^{n} c_i f(x_i)$$
公式是这样子的

### 我们在干什么？

我们需要构造一个矩阵$C_{n,m}$，表示“用到第n个点时，计算m阶导数的权重”
```
c[k, j] = ((c4 * c[k, j]) - (k * c[k - 1, j])) / c3
```

我们首先需要明白我们在干什么，我们在求一个多项式插值函数的导数。插值多项式的每一项通常长这样$$P(x) = (x - x_0)(x - x_1)...(x - x_n) \times \text{系数}$$
当你对这一长串乘积求导时，会发生什么？ 根据导数的乘法法则：$$\frac{d}{dx} [ (x - a) \cdot f(x) ] = 1 \cdot f(x) + (x - a) \cdot f'(x)$$所以在k阶导数的结果里，必然包含着k-1阶导数的“影子”

### 推导（如何实现？）

我们来看拉格朗日插值基函数：它的特点是基函数$L_j(x)$在$x_j$处高度为1，在其他坐标点处高度为0。但是当我们在更新了一个新的点$x_{new}$后，旧的插值基函数就不太能完成这个任务了，所以我们得需要为插值基函数作一次更新：$$L_{new} = L_{old}\frac{x_{new} - x}{x_{new} - x_j}$$
- 当 $x = x_{new}$ 时，分子为0，整个式子变成0。**（满足了新点的要求）**
- 当 $x = x_j$ 时，分子分母相等，变成了 $1 \times 1 = 1$。**（保持了旧点的要求）**

这之后，我们要对新的插值基函数进行求导，采用莱布尼茨求导公式（高阶导数的乘法法则）：
我们令$u = L_{old}(x)$，令 $v = \frac{x_{new} - x}{x_{new} - x_j}$。 那么令 $w(x) = u \cdot v$$$(uv)^{(m)} = u^{(m)}v + m \cdot u^{(m-1)}v' + \dots$$
又因为v只是关于x的线性函数，所以v的二阶及以上导数全都是0。所以求导之后就变成：$$w^{(k)}(z) = u^{(k)}(z) \cdot v(z) + k \cdot u^{(k-1)}(z) \cdot v'(z)$$这是插值基函数的k阶导数

将前面的 $v(z)$ 和 $v'(z)$ 的值代入：$$\begin{aligned} w^{(k)}(z) &= u^{(k)}(z) \cdot \left( \frac{x_i - z}{x_i - x_j} \right) + k \cdot u^{(k-1)}(z) \cdot \left( \frac{-1}{x_i - x_j} \right)= \frac{u^{(k)}(z)(x_i - z) - k \cdot u^{(k-1)}(z)}{x_i - x_j} \end{aligned}$$
即$$\begin{aligned} w^{(k)}(z) = \frac{u^{(k)}(z)(x_i - z) - k \cdot u^{(k-1)}(z)}{x_i - x_j} \end{aligned}$$
所以一阶形式就是$$\begin{aligned} w^{'}(x) = \frac{u^{'}(z)(x_i - z) - k \cdot u(z)}{x_i - x_j} \end{aligned}$$
我们再看回代码
```
c[k, j] = ((c4 * c[k, j]) - (k * c[k - 1, j])) / c3
```
- `c[k, j]` (等号右边)：**旧权重**。还没加入新点 $x_i$ 时的权重。
- `c[k-1, j]`：**降阶权重**。求低一阶导数时的权重。
- `c4 = x[i] - z`：**距离因子**。新加入的点到目标点的距离。
- `c3 = x[i] - x[j]`：**缩放因子**。新点和当前旧点的距离。

### 那得出这个之后能干什么？
### 或者说 为什么在有限差分法中，某个点 $x_j$ 的“权重”，在数学上严格等价于该点的“拉格朗日基函数”在目标位置 $z$ 处的“导数值”？

首先我们来回忆我们是如何构造拉格朗日插值函数的$$f(x) \approx \sum_{j} f(x_j) \cdot L_j(x)$$
然后我们要求导数$$f^{(k)}(z) \approx \sum_{j} f(x_j) \cdot {L_j^{(k)}(z)}$$
我们再看有限差分的公式，有限差分算法的目标是求出一组权重 $c_j$，使得：$$f^{(k)}(z) \approx \sum_{j} c_j \cdot f(x_j)$$
这样看来权重c就与拉格朗日基函数的导数值在数学上完全相等了
所以，代码中的矩阵$C_{k, j}$可以这样理解
- **从算法角度看**：它是权重。我想求导数时，把观测值 $f(x_j)$ 乘以它，然后加起来。
- **从数学角度看**：它是导数值。它代表了如果我们只把 $x_j$ 这个点抬高 1 米（其他点不动），这根插值曲线在目标点 $z$ 处的 $k$ 阶导数会变成多少。

### 刚刚我们所完成的是旧权重的更新，现在我们给新的节点$x_i$安排一个权重

同样，我们在$x_i$处的拉格朗日基函数$L_i(x)$为$$\begin{aligned} L_i(x) = \frac{(x - x_0)(x - x_1)...(x - x_{i-1})}{常数分母} \end{aligned}$$
所以，我们可以建立一个递归关系$$\text{新分子}(x) = \text{旧分子}(x) \times (x - x_{i-1})$$
接下来我们需要对新分子求k阶导数，令 $u(x) = \text{旧分子}(x)$，令 $v(x) = (x - x_{i-1})$
根据莱布尼茨乘法法则 $(uv)^{(k)} = u^{(k)}v + k u^{(k-1)}v'$
再令$w = uv$ ，再结合题目实际条件，得$w'=u'v+kuv'$

我们再将数学映射回代码
- **`c[k, i-1]`**：对应 $u^{(k)}$。这是上一轮循环算出来的，针对上一个点 $x_{i-1}$ 的同阶导数权重。
- **`c[k-1, i-1]`**：对应 $u^{(k-1)}$。这是上一轮的低一阶导数权重。
- **`c5`** 和 **`c1`**：这两个是常数分母的缩放因子，用于归一化。